## MS17-010

### Eternal Blue
* Affects anything using SMBv1 file sharing protocol
* Leaked by Shadow Brokers hacking group from the NSA

### How does it work?
* SMBv1 first developed in 1983 as a network communication protocol to enable shared access to files, printers, and ports
* A way for Windows machines to talk to one another and other devices for remote services
* protocol can communicate information about a file's extended attributes(essentially metadata) about the file's properties on the file system
* Exploit makes use of how Windows mishandles specially crafted packets from malicious attackers
* relies on srv!Srv0S2FeaListSizeToNt
* Eternalblue takes advantage of three bugs

### In detail
* First bug is a mathmatical error when the protolc tires to cast an OS/2 FileExtended Attribute(FEA) list strcture to an NT FEA strue in order to determine how much memory to allocate
* A miscalcualtion causes an integer overflaw that causes less memory to be allocated than expected 
* More data than expected is written causing a buffer overflow which overflows into adjacent memory space which is the second bug
* The buffer overflow is possible because of two related sub commands: SMB_COM_TRANSACTION2 and SMB_COM_NT_TRANSACT 
* Both have a \_SECONDARY command which is used when there is too much data to include in a single packet
* Difference between the two is that the latter calls for a data packet twice the size of the former
* Error validation occurs if the client sends a crafted message using NT_TRANSACT subcommand immediately before TRANSACTION2
* While the protocol recognizes that two sub-commands have been received, it assigns the type and size of both packets based only on the type of the last one received
* Since the last one is smaller, the first packet will occupy more space than it is allocated
* Once  the attackers achieve this initial overflow, the third bug of SMBv1,  heap spraying results in allocating a chunk of memory at a given address
* the attacker can write and execute shellcode
